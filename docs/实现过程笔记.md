[toc]

## 通用

### 基础配置

对 `.yml`，使用变量法如 `password: ${MYSQL_PASSWORD:root}`，这个变量由打包后的 jar 包根据命令行参数传入，方便 Docker。调试时，可以用 `application-local`。

需要自行修改配置项，完成 Redis, MySQL 配置。如有必要，分配不一样的 root 密码。当后端启动时，如果数据库没有权限组、root 用户，将会自动新建。

### 代码规范设计

分模块存储，把只有一个模块用的 `DTO` 和前端请求 `Request` 存到模块下面，权责清晰，且方便以后分离。

服务类注入到控制器类不写 autowired，用构造函数注入，Spring 官方推荐。优点：方便单元测试、不会空指针、可以 final (线程安全)。构造函数可以 `@RequiredArgsConstructor`。

`ApiResponse<T>` 是统一接口返回壳，核心目的是让前后端始终按同一结构通信。对错误，`ErrorCode` 枚举类+5位错误状态码和信息。

## 用户模块

### 权限

> 启动项目时，自动触发 `PermissionGroupInitializer`，它查询数据库，若无权限组信息，新建三个默认权限组。如果没有 root 账号，按照 `application` 配置生成指定账号密码的 root 账号。如果没修改过，默认值是账号名 `root`，密码 `dynamicCD+ACAM` (AC自动机上动态点分治)。
>
> 在 `SecurityConfig`：
>
> - 关闭 CSRF：防止 POST 等被拦截
> - 开启无状态会话：服务器不创建 `HttpSession`，请求带 token，后端验证 token，横向扩容简单。
> - 密码加密策略：`BCryptPasswordEncoder`
> - 统一异常响应

### 登录注册

#### 验证码

生成的验证码 ID 发前端，答案存储 Redis，默认 5 分钟验证码过期，暂时不做可调整设计，也就是从生成到提交必须在 5 分钟内。注册/登录时前端把 ID 和用户答案输入。

#### 注册

若未能通过图形验证码、重复用户名、重复邮箱检测，返回失败。

成功：插入新用户到 MySQL。乐观防止并发：插入时还有可能会报错重复用户名/邮箱，抛出异常即可。

> 其他逻辑前端做：两次密码输入一致(只传一个给后端)、登陆成功跳转主页等

额外提供接口：查询是否开放注册。不开放前端不显示注册入口。

查询时，跳过软删除列。

#### 登录

若未能通过图形验证码、密码检验，返回失败。

登陆成功更新最后登录时间，然后返回两个 JWT 令牌。

- refresh token：登出/超过有效时间就过期，要求重新登陆

- access token：实际使用来调 API 的令牌，过期快；过期时，前端自动用 refresh token 请求一个新的 access token，静默续期，用户不会有任何感觉。更换 token 时是旋转：服务端丢掉旧 token，防止重放续期

  每次换 access，refresh 也会换。二者重新倒计时

  > 在一些方案里， refresh 的过期时间还是跟换前一样。

配置项决定它们的过期时间。

双 token 的意义：安全。防止抓取到 access token 后一直被利用。access 常换，refresh 少传递(仅刷新用)，降低被截获的可能性。

refresh token 存 Redis。 `application` 配置密钥。JWT id 是 UUID。

现在的设计是会话键是主数据，Set 是索引。注意到一个用户会有多端登录(如本机，考场，手机)，所以用户 ID 对 token 是 set。Redis 如此维护，避免扫描全部 keys，可以优化。主要业务是：改密时用来删除全部 tokens。在其他登录登出业务注意同时维护即可(还有key是tokenid的会话键，用于检查token是否存在，以及旋转删除)。

> 理由：redis 的 key 是哈希不是树，要模糊找 key 就是扫描全部 keys，性能不行。

#### 登出

删 refresh token Redis，把 access token 加入 Redis 黑名单。任意失败不管直接返回。

1. 检查 bearer 格式，拿到 JWT 字符串，解析 payload，判断它是不是 access，若已过期不删，未过期写入黑名单
2. 同理，把 refresh 走流程删掉。

#### 续签

同理解析，若传入的 refresh token 不在 redis，那就是登出/过期了，抛出异常。

否则，删掉旧的 refresh token，查询用户确认存在，然后发新的双 token。

### 个人信息

> 基本上的 MySQL CRUD 没啥好说的。注意多个 redis 操作原子性，可以用一次指令多个 key 或原子指令完成。

#### 列举个人信息

对用户自己，使用 JWT 查询个人信息，能获得更多信息。

列举任意用户，输入 URL 或点击别的地方进来。只能看到一部分比如个人简介、昵称等。

#### 修改用户信息

修改邮箱改成未验证。注意做事务。注意检查邮箱重复。

修改密码看看旧对不对，新的和旧的一不一样。

修改个人简介就直接修改即可。



## 测试

默认只运行单元、切面测试，不允许集成测试。可以单独运行集成，会使用独立的数据库 `lunaroj-test`（需要事先手动建表），保证数据隔离。

压力测试：属于集成测试，使用虚拟线程，用 `CountDownLatch` 控制瞬时并发。

