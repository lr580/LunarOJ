[toc]

## 数据表设计

数据表：

```sql
CREATE DATABASE lunaroj
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_0900_ai_ci;
```

### 用户

#### 用户表

```sql
CREATE TABLE `user` (
    `id`                   BIGINT UNSIGNED NOT NULL,
    `username`             VARCHAR(64)     NOT NULL COMMENT '登录用户名(唯一)',
    `password`             VARCHAR(128)    NOT NULL COMMENT '密码(BCrypt加盐)',
    `nickname`             VARCHAR(64)     NOT NULL COMMENT '昵称',
    `email`                VARCHAR(191)    NULL     COMMENT '邮箱',
    `email_verified`       BOOLEAN         NOT NULL DEFAULT 0 COMMENT '邮箱是否已验证',
    `permission_group_id`  BIGINT UNSIGNED NOT NULL COMMENT '权限组ID',
    `profile`              TEXT            NULL     COMMENT '个人主页Markdown',
    `default_code_public`  BOOLEAN         NOT NULL DEFAULT 0 COMMENT '提交代码默认是否公开',
    `last_login_at`        DATETIME        NULL     COMMENT '最后登录时间',
    `created_at`           DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    `updated_at`           DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`           DATETIME        NULL COMMENT '软删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_username` (`username`),
    INDEX `idx_permission_group` (`permission_group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户';

ALTER TABLE `user`
  ADD COLUMN `email_active` VARCHAR(191)
    GENERATED ALWAYS AS (CASE WHEN `deleted_at` IS NULL THEN `email` END) STORED,
  ADD UNIQUE KEY `uk_email_active` (`email_active`);
```

- **id** 雪花ID，如无特殊说明，后面都是

- **username** 登录用户名只能大小写英文+阿拉伯数字+`-_.`

  大小写不敏感(登录时和注册防重时)。与主流平台 cf、力扣、atc、Github 一致，以及 Socoding OJ 一致。依赖 `_ci` collation 实现

  但存储时保留大小写，不要一律转小写，与 Socoding OJ 保持一致

- **deleted_at** 用于删除用户，但不删除用户对应的提交代码等数据

- **email** 可以为空(不验证邮箱)，root 可以调，所以设可 NULL

限频字段存 Redis 可以，不需要放 MySQL：

- `last_nickname_change` '上次修改昵称时间(限频)',
- `last_profile_change` '上次修改个人主页时间(限频)',

同理，JWT 字段存 Redis，不走 MySQL。

> 不打算做，未来可做：
>
> ```sql
> `avatar_url` VARCHAR(512) NULL COMMENT '头像URL(MinIO)',
> ```

如果经常前缀搜索用户昵称，也可以加个索引列。

> 防重列需求参见用户属性表。

#### 权限组表

```sql
CREATE TABLE `permission_group` (
    `id`          BIGINT       UNSIGNED NOT NULL,
    `name`        VARCHAR(64)  NOT NULL COMMENT '权限组名称',
    `permissions` JSON         NULL     COMMENT '权限列表 ',
    `description` VARCHAR(255) NULL     COMMENT '描述',
    `is_built_in` BOOLEAN      NOT NULL DEFAULT 0 COMMENT '是否内置(内置不可删除)',
    `created_at`  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限组';
```

- **name** 权限组默认有 `USER / ADMIN / ROOT` 三个

  varchar 64 是为了可扩展 (root 可以自定义新的组，其name可能长)

  > 一般建议不是中文，暂不考虑做限制
  >
  > 不拿 name 当 PK，理由是若更新，级联更新 FK 不方便且比 bigint 大

- **permissions** JSON 便于动态扩展，为简单起见，使用扁平设计，如：

  `["problem.read","contest.rejudge"]`

  > 分模块的话是 `{"problem":["read","edit"]}`，暂不考虑。
  >
  > 用 JSON 好处是类型约束，保证合法

- **description** 对该组的描述，备注，可中文

> 暂不考虑添加：**deleted_at** 软删除，等效于做隐藏。未来可以实现。
>
> 因为只有 root 可以更改这个表，所以不考虑设置 created_by, updated_by。

> id 雪花和自增都行。这里默认雪花。

#### 通知表

```sql
CREATE TABLE `notification` (
    `id`          BIGINT UNSIGNED NOT NULL,
    `user_id`     BIGINT UNSIGNED NOT NULL COMMENT '接收用户',
    `type`        TINYINT       NOT NULL COMMENT '消息类型',
    `title`       VARCHAR(255)  NOT NULL,
    `content`     TEXT          NULL,
    `read_at`     DATETIME      NULL,
    `created_at`  DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `deleted_at`  DATETIME      NULL COMMENT '软删除',
    PRIMARY KEY (`id`),
    INDEX `idx_user_read_created` (`user_id`, `read_at`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知消息';
```

做索引优化，以方便 select。业务侧定义具体每种 type 的名字等。包含的通知有：

1. 讨论动态通知：被回复、被删除
2. 小组动态通知：用户申请加入、用户主动退出、被踢出小组
3. 出题动态通知：审核通过、审核不通过、题目被撤回
4. 账号动态通知：个人信息(昵称、主页)违规

管理员侧，包含的独特通知有：

1. 账号申诉通知：用户忘记密码(请求重置密码为指定值/默认123456)
2. 审题通知：新的题目待审核

> 业务侧决定跳转到什么资源，不存来源 URL。后面再决定这些通知 type 的具体字面量。

#### 用户属性表

```sql
CREATE TABLE `user_attribute` (
    `user_id`    BIGINT UNSIGNED NOT NULL,
    `attr_key`   VARCHAR(64)     NOT NULL COMMENT '属性名',
    `attr_value` VARCHAR(191)    NOT NULL COMMENT '属性值',
    PRIMARY KEY (`user_id`, `attr_key`),
    UNIQUE KEY `uk_key_value` (`attr_key`, `attr_value`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户扩展属性';
```

EAV 防重表。未来用于存储：学号、手机、联系方式等字段，并选择任意一到多个进行注册防重。

> 考虑删掉 unique key，如果有列不用于防重的话。

### 题目

#### 标签分类表

```sql
CREATE TABLE `tag_category` (
    `id`         BIGINT UNSIGNED NOT NULL,
    `name`       VARCHAR(16)  NOT NULL COMMENT '分类名',
    `sort_order` INT          NOT NULL DEFAULT 0,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签分类';
```

用于多个维度进行筛选题目，每个维度是一个类别，如考点、出处。参考洛谷。

- **sort_order** 是在排列各种筛选类型的顺序，越小越前。下同。

  > 避免使用 order 这个关键字 (order by)

> ID 雪花和自增都行。这里默认雪花。下同。
>
> 认为这种非重要的列，没有必要做审计，故不设计 created_at 等。下同。

#### 标签表

```sql
CREATE TABLE `tag` (
    `id`          BIGINT UNSIGNED NOT NULL,
    `name`        VARCHAR(64)  NOT NULL COMMENT '标签名',
    `category_id` BIGINT  UNSIGNED NOT NULL COMMENT '所属分类',
    `sort_order`       INT     NOT NULL DEFAULT 0,
    PRIMARY KEY (`id`),
    UNIQUE KEY uk_category_name (category_id, name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签';
```

> 不考虑为分类和标签添加颜色字段，认为没必要。前端随便选即可。
>
> 不应该把标签看成弱实体，仍然需要 ID。

#### 题目表

```sql
CREATE TABLE `problem` (
    `id`                BIGINT UNSIGNED NOT NULL,
    `display_id`        VARCHAR(16)     NULL COMMENT '题目在后台管理的显示ID',
    `title`             VARCHAR(255)  NOT NULL COMMENT '题目标题',
    `description`       MEDIUMTEXT    NOT NULL COMMENT '题面Markdown/HTML',
    `input_description` TEXT          NULL     COMMENT '输入描述',
    `output_description` TEXT         NULL     COMMENT '输出描述',
    `samples`           JSON          NULL     COMMENT '样例列表',
    `note`              TEXT          NULL     COMMENT '提示',
    `time_limit`        INT           NOT NULL DEFAULT 1000 COMMENT '时间限制(ms)',
    `memory_limit`      INT           NOT NULL DEFAULT 262144 COMMENT '内存限制(KB), 默认256MB',
    `difficulty`        INT           NULL     COMMENT '难度, NULL为未设置',
    `difficulty_source` BOOLEAN       NOT NULL DEFAULT 0 COMMENT '难度来源 0-自动(AI) 1-手动设置',
    `solution`          MEDIUMTEXT    NULL     COMMENT '题解Markdown',
    `solution_visible`  BOOLEAN       NOT NULL DEFAULT 0 COMMENT '题解是否可见',
    `std_code`          MEDIUMTEXT    NULL     COMMENT '标程代码',
    `std_language`      TINYINT       NULL     COMMENT '标程语言 0-C++, 1-C, 2-Python, 3-Java, 4-txt',
    `std_visible`       BOOLEAN       NOT NULL DEFAULT 0 COMMENT '标程是否可见',
    `judge_mode`        TINYINT       NOT NULL DEFAULT 0 COMMENT '0-常规 1-SPJ 2-填空题 3-交互题',
    `scoring_config`    JSON          NULL COMMENT '测试点分值配置',
    `spj_code`          MEDIUMTEXT    NULL     COMMENT 'SPJ代码',
    `spj_language`      TINYINT       NULL     COMMENT 'SPJ语言',
    `accept_count`      INT           NOT NULL DEFAULT 0 COMMENT 'AC数',
    `submit_count`      INT           NOT NULL DEFAULT 0 COMMENT '提交数',
    
    `status`            TINYINT NOT NULL DEFAULT 0 COMMENT '0-草稿 1-待审核 2-已发布 3-已下架',
    `reviewed_by`       BIGINT UNSIGNED NULL COMMENT '审核题目者的用户ID',
    `reviewed_at`       DATETIME      NULL,
    `created_by`        BIGINT UNSIGNED NOT NULL COMMENT '创建者用户ID',
    `created_at`        DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_by`        BIGINT UNSIGNED NOT NULL,
    `updated_at`        DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_by`        BIGINT UNSIGNED NULL,
    `deleted_at`        DATETIME      NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_display_id` (`display_id`),
    INDEX `idx_creator` (`created_by`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题目';
```

- **display_id** 是方便管理员查看；且公共题库一般沿用它。在比赛中会单独设置显示 ID。
- **samples** 是所有样例输入和输出 JSON 格式 `[{"input":"...","output":"..."},...]`
- **notes** 一般是：部分分说明，样例解释，更新说明
- **difficulty** 对标CF rating，也可以按需自定义，如对标[力扣](https://zerotrac.github.io/leetcode_problem_rating/)
- **scoring_config** 对标 OI/IOI 子任务配置，参考 [Socoding OJ 格式](https://github.com/scnu-socoding/scnuoj/blob/master/views/wiki/oi.php)
- **std_language** 使用整型而不是 varchar，因为不同地方可能用的字符值不一样(如沙箱cpp，前端C++)，以及牵扯到编译器版本
- **judge_mode** 保留以后添加其他选项的可能性
- **spj_language** DOMjudge 的 output validator 可以用任意语言，只需编译/运行后通过退出码返回结果
- **status** 草稿：已保存但还不想提交审核；已下架：因为一些原因需要把已发布的题目退掉时可用

> 注意题目(题面、输入输出格式描述等)本身应当存数据库，编辑检索方便，如 Socoding OJ (SCNUOJ), Online Judge (QDU OJ)，Hydro OJ，HUST OJ。例外是 DOM Judge，它的题目是 PDF 文件。

> TODO 是否要垂直分表？MVP 先不做吧。

> 对样例输入输出，Socoding OJ 的做法是存两个 TEXT，处理字符串解析得到样例。不考虑分表，太麻烦，故可以做 JSON 存字符串。
>
> 但是，若希望样例也测。而 DOM Judge 和 online judge (qduoj/csoj) 的模式是样例本身是测试点，按测试点存储即可。考虑这个功能，可以前端添加一键把样例转为测试点，或反之。一个坏处是走文件读写比纯查分表/单表JSON慢。
>
> 这里设计样例与测试点无关，因为考虑到一些出题人给分策略(OI/IOI)可能不希望让样例算分。而且也比文件IO快。

> 一些看似是题目内容但不存储在这里的是：显示id (随题库变化)、测试点给分方式 (题目配置文件确定)
>
> 标题、题面内容不走 MySQL 索引，对检索需求用其他手段实现；其他内容也可以走 Redis。

> 不设计每个样例单独解释，在题目里统一解释。与 Socoding OJ、洛谷等保持一致。

> 暂时不考虑设计由代码生成的样例、热点生成缓存相关的数据库结构。MVP 之后有空可以实现。

> 总分由 scoring_config 设置，不保留下面字段：
>
> ```sql
> `total_score` INT NOT NULL DEFAULT 0 COMMENT '总分, 0表示不设置',
> ```

> **accept_count** 等字段在业务侧注意并发更新竞态问题

#### 题目标签表

```sql
CREATE TABLE `problem_tag` (
    `problem_id` BIGINT UNSIGNED NOT NULL,
    `tag_id`     BIGINT UNSIGNED NOT NULL,
    PRIMARY KEY (`problem_id`, `tag_id`),
    INDEX `idx_tag_id` (`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题目-标签关联';
```

虽然题目与样例、标签都是一对多关系。但是标签经常用来查询，单独分表更加合适。

标签分类表、标签表是实体，需要 ID，但是题目标签是关联，不需要分配额外 ID。

#### 测试点表

```sql
CREATE TABLE `testcase` (
    `id`              BIGINT UNSIGNED NOT NULL,
    `problem_id`      BIGINT UNSIGNED NOT NULL,
    `sort_order`      INT             NOT NULL DEFAULT 0,
    `input_path`      VARCHAR(255)    NULL     COMMENT '输入文件MinIO路径',
    `output_path`     VARCHAR(255)    NULL     COMMENT '输出文件MinIO路径, NULL表示待生成',
    `input_size`      BIGINT          NULL     COMMENT 'bytes',
    `output_size`     BIGINT          NULL     COMMENT 'bytes',
    `input_hash`      VARCHAR(64)     NULL     COMMENT '输入文件SHA-256',
    `output_hash`     VARCHAR(64)     NULL     COMMENT '输出文件SHA-256',
    `created_by`      BIGINT UNSIGNED NOT NULL COMMENT '创建者用户ID',
    `updated_by`      BIGINT UNSIGNED NOT NULL COMMENT '最后修改者用户ID',
    `created_at`      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_testcase` (`problem_id`, `sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='测试点';
```

- path：测试点/附件本身必须存文件。
- 大小字段：①快速统计限额；②方便CRUD管理展示，不必每次都调 MinIO
- 哈希字段：SHA-256 hex是64字符。作用有三①上传时去重；②重判时校验是否被修改；③可以快速检查标程重新生成的输出是否不一样

> 其他实现：Socoding OJ 和 Online Judge 数据库不存测试点，通过扫描文件路径发现。HUSTOJ 用配置文件描述测试点信息。DOMJudge 有数据表存测试点元数据。
>
> 弱实体一般不需要 ID 字段。但加上 ID 方便并发和 CRUD。
>
> 填空题可以无输入(NULL)。
>
> 未实现代码生成的测试点的管理。MVP 后可考虑。

#### 题目讨论表

```sql
CREATE TABLE `problem_discussion` (
    `id`          BIGINT UNSIGNED NOT NULL,
    `problem_id`  BIGINT UNSIGNED NOT NULL COMMENT '关联题目ID',
    `contest_id`  BIGINT UNSIGNED NULL     COMMENT '关联比赛ID',
    `parent_id`   BIGINT UNSIGNED NULL     COMMENT 'NULL表示主帖，非NULL表示回复某主帖',
    `reply_to_id` BIGINT UNSIGNED NULL     COMMENT '被回复的楼层ID，用于二级回复@提示',
    `user_id`     BIGINT UNSIGNED NOT NULL COMMENT '发帖/回复用户',
    `title`       VARCHAR(255)    NULL     COMMENT '讨论标题，仅主帖有值',
    `content`     MEDIUMTEXT      NOT NULL COMMENT '内容Markdown',
    `is_pinned`   BOOLEAN         NOT NULL DEFAULT 0 COMMENT '是否置顶，仅主帖有效',
    `created_at`  DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`  DATETIME        NULL,
    `deleted_by`  BIGINT UNSIGNED NULL     COMMENT '删除者(管理员或作者)',
    PRIMARY KEY (`id`),
    INDEX `idx_problem_parent` (`problem_id`, `parent_id`, `is_pinned` DESC, `created_at` DESC),
    INDEX `idx_contest_parent` (`contest_id`, `parent_id`, `created_at` DESC),
    INDEX `idx_user_created` (`user_id`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题目讨论';
```

- 考虑到讨论用得少，而回复用的更少，不考虑把原贴和回帖分表，直接做树结构(根parent，父reply_to，方便查询，避免真的遍历树)

  **parent_id** NULL 为主帖，非 NULL 为回复；只支持二级，回复的 `parent_id` 指向主帖 ID，业务层禁止对回复再回复

  **reply_to_id** 仅用于前端展示"回复@xxx"，不影响层级结构；可指向同一主帖下任意楼层

- **title** 仅主帖有值，回复为 NULL

- **is_pinned** 仅主帖有效，管理员可置顶

> 不支持点赞、举报等功能，MVP 阶段不考虑。
>
> 在 Socoding OJ，把公告、讨论、赛时答疑合在一起了。这里设计分开。
>
> - **idx_problem_parent** 主帖列表查询：`WHERE problem_id=? AND parent_id IS NULL ORDER BY is_pinned DESC, created_at DESC`
>
> - **idx_parent_created** 回复列表查询：`WHERE parent_id=? ORDER BY created_at` ，疑似多余
>
>   ```sql
>   INDEX `idx_pending` (`status`, `created_at`)
>   ```
>
> 讨论可见性跟随题目状态，业务层联查 `problem.status` 判断，不在此表存冗余字段

### 代码

避免表太大查询慢，对代码进行分表

- 垂直分表：提交主表(元数据，结果摘要等)和提交代码表(代码、各测试点结果等)，分别对应分页列举功能，和查看详细提交状态功能所需的数据
- 水平分表：代码表可按月分表 (业务侧决定分表周期)。主表不大不用水平分

#### 提交主表

```sql
CREATE TABLE `submission` (
    `id`           BIGINT UNSIGNED NOT NULL,
    `user_id`      BIGINT UNSIGNED NOT NULL COMMENT '提交用户ID',
    `problem_id`   BIGINT UNSIGNED NOT NULL COMMENT '题目ID',
    `problem_set_id` BIGINT UNSIGNED NULL   COMMENT '题库ID',
    `contest_id`   BIGINT UNSIGNED NULL     COMMENT '比赛ID，NULL表示练习提交',
    `code_length`  INT             NOT NULL COMMENT '代码字节数',
    `language`     TINYINT         NOT NULL COMMENT '语言 0-C++ 1-C 2-Python 3-Java 4-txt',
    `status`       TINYINT         NOT NULL DEFAULT 0 COMMENT '0-WT0 1-WT1 2-CI 3-RI 4-AC 5-PE 6-WA 7-TLE 8-MLE 9-OLE 10-RE 11-CE 12-SE 13-NT',
    `score`        INT             NOT NULL DEFAULT 0 COMMENT '得分(OI模式，ACM模式恒为0)',
    `time_used`    INT             NULL     COMMENT '最大时间开销(ms)，评测完成前为NULL',
    `memory_used`  INT             NULL     COMMENT '最大内存开销(KB)，评测完成前为NULL',
    `pass_count`   INT             NOT NULL DEFAULT 0 COMMENT '通过测试点数',
    `total_count`  INT             NOT NULL DEFAULT 0 COMMENT '总测试点数',
    `is_public`    BOOLEAN         NOT NULL DEFAULT 0 COMMENT '代码是否公开',
    `judged_at`    DATETIME        NULL     COMMENT '评测完成时间',
    `created_at`   DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '提交时间',
    PRIMARY KEY (`id`),
    INDEX `idx_user_created`   (`user_id`, `created_at` DESC),
    INDEX `idx_problem_status` (`problem_id`, `status`, `created_at` DESC),
    INDEX `idx_problem_set_user` (`problem_set_id`, `user_id`, `created_at` DESC),
    INDEX `idx_contest_user` (`contest_id`, `user_id`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='提交记录';
```

- **id** 雪花ID，时间戳部分可用于路由到 `submission_code` 分表

- **contest_id** NULL 表示验题等无比赛的提交

- **language** 与上文枚举保持一致，业务侧统一维护枚举类

- **status** 状态机：`WT0/WT1 → CI → RI → 终态`，与 [Socoding OJ 保持一致](https://github.com/scnu-socoding/scnuoj/blob/master/models/Solution.php)。

  | int  | 缩写 | 含义                             |
  | ---- | ---- | -------------------------------- |
  | 0    | WT0  | Pending（等待判题）              |
  | 1    | WT1  | Pending Rejudge（等待重判）      |
  | 2    | CI   | Compiling（编译中）              |
  | 3    | RI   | Running & Judging（运行/评测中） |
  | 4    | AC   | Accepted                         |
  | 5    | PE   | Presentation Error               |
  | 6    | WA   | Wrong Answer                     |
  | 7    | TLE  | Time Limit Exceeded              |
  | 8    | MLE  | Memory Limit Exceeded            |
  | 9    | OLE  | Output Limit Exceeded            |
  | 10   | RE   | Runtime Error                    |
  | 11   | CE   | Compile Error                    |
  | 12   | SE   | System Error                     |
  | 13   | NT   | No Test Data                     |

- **code_length** 冗余字段，方便列表展示代码长度

- **score** ACM 模式不使用（恒为 0）；OI 模式存实际得分，由 `case_results` 汇总写入

- **time_used / memory_used** 取所有测试点中的最大值，CE 时为 NULL

- **pass_count / total_count** 冗余字段，避免每次展示都解析 `submission_code.case_results` JSON

  > 在 Socoding OJ 里是单一字符串列 pass_info 如 `11/11`。

- **is_public** 初始值取自提交时 `user.default_code_public`，用户可在提交时覆盖

> 不设 `created_by` / `updated_by`，提交记录本身即代表用户行为，`user_id` 已足够。
>
> 不设软删除，提交记录不允许删除（保留历史数据完整性）。管理员如需隐藏，可在业务层过滤。 
>
> index 的设计有待业务侧斟酌优化。TODO。如：**idx_pending** 用于评测机轮询待评测任务（实际由 RabbitMQ 驱动，此索引作为兜底补偿查询）
>
> ```sql
> INDEX `idx_pending` (`status`, `created_at`)
> ```

#### 提交代码表

```sql
CREATE TABLE `submission_code` (
    `submission_id`  BIGINT UNSIGNED NOT NULL,
    `code`           MEDIUMTEXT      NOT NULL COMMENT '提交代码',
    `compile_output` TEXT            NULL     COMMENT '编译器输出(CE时非NULL)',
    `case_results`   JSON            NULL     COMMENT '测试点结果列表，CE时为NULL',
    PRIMARY KEY (`submission_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='提交代码(垂直分表)';
```

- **code** MEDIUMTEXT（16MB），与上文保持一致，覆盖 Java 等冗长语言

- **compile_output** 仅 CE（status=11）时写入，其余为 NULL；TEXT 64KB 足够编译器输出

- **case_results** 评测完成后一次性写入

  > CE 时为 NULL；实时逐点推送进度走 WebSocket/SSE，不依赖此字段

此表按月分表：`submission_code_202501`、`submission_code_202502`……

MyBatis-Plus 动态表名拦截器实现，路由键从 `submission.id`（雪花ID）中提取时间戳得到年月。

> compile_output 不省略/合并，如果 CE 没 case_results；分离可读性更好。

> 查询时若跨月（如用户提交历史），需要业务层按月范围依次查询后合并，或只在详情页按单条 ID 查询（最常见场景）。与主表 1:1，不设额外索引，只按主键查。
>
> 可以对非最新的水平分表开表/页级压缩。运维时再决定

### 题库

#### 题库表

```sql
CREATE TABLE `problem_set` (
    `id`             BIGINT UNSIGNED NOT NULL,
    `name`           VARCHAR(255)    NOT NULL COMMENT '题库名',
    `description`    TEXT            NULL     COMMENT '题库描述Markdown',
    `team_id`       BIGINT UNSIGNED NOT NULL COMMENT '所属小组ID',
    `testcase_view`  TINYINT         NOT NULL DEFAULT 1 COMMENT '测试点查看方式 0-不允许 1-截断部分 2-全部与下载',
    `display_format` TINYINT         NOT NULL DEFAULT 0 COMMENT '题目显示ID格式 0-字母(A-Z) 1-数字',
    `created_by`     BIGINT UNSIGNED NOT NULL,
    `created_at`     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_by`     BIGINT UNSIGNED NOT NULL,
    `updated_at`     DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`     DATETIME        NULL,
    PRIMARY KEY (`id`),
    INDEX `idx_team` (`team_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题库';
```

- **team_id** 逻辑外键。对未设比赛的题库，需要该字段控制可见性
- **testcase_view** 统一控制该题库内所有题目的测试点可见性。比赛默认 0；公共题库默认 1。不设每题粒度的控制
- **display_format** 决定新增题目时题号的自动生成规则：字母（A、B…Z）或数字（1、2…）。超过26题时自动切换为数字，或由管理员手动修改
- **deleted_at** 软删除；题库删除后其关联的比赛不受影响

> 题库可见性由比赛决定：若无比赛关联，该题库仅对小组管理员和组长可见。可见性逻辑在业务层处理，不在此表存字段

#### 题库题目表

```sql
CREATE TABLE `problem_set_problem` (
    `problem_set_id` BIGINT UNSIGNED NOT NULL,
    `problem_id`     BIGINT UNSIGNED NOT NULL,
    `display_id`     VARCHAR(16)     NULL COMMENT '题目在该题库中的显示ID',
    `sort_order`     INT             NOT NULL DEFAULT 0 COMMENT '排列顺序',
    PRIMARY KEY (`problem_set_id`, `problem_id`),
    UNIQUE KEY `uk_set_display` (`problem_set_id`, `display_id`),
    INDEX `idx_problem` (`problem_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题库-题目关联';
```

- **display_id** 在题库内唯一，由业务层按 `problem_set.display_format` 自动生成，管理员可手动覆盖。足以覆盖字母、数字及未来自定义格式（如 `P1001`、`Day1A`）。不设置的话按 sort_order (1-indexed)。
- **sort_order** 控制题目在题库中的展示顺序，支持拖拽重排；`display_id` 与 `sort_order` 独立，允许顺序与显示ID不一致（如重排后不重新编号）

> 此表是关联表，不需要独立 ID。下同。

#### 题库标签表

```sql
CREATE TABLE `problem_set_tag` (
    `problem_set_id` BIGINT UNSIGNED NOT NULL,
    `tag_id`         BIGINT UNSIGNED NOT NULL,
    PRIMARY KEY (`problem_set_id`, `tag_id`),
    INDEX `idx_tag` (`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题库-标签关联';
```

与题目共用 `tag` / `tag_category` 标签集，由管理员和 root 维护。

`idx_tag` 用于反查某标签下的所有题库。



### 比赛

#### 比赛表

```sql
CREATE TABLE `contest` (
    `id`                  BIGINT UNSIGNED NOT NULL,
    `display_id`          VARCHAR(32)     NULL     COMMENT '用户可见的比赛ID，NULL表示未发布',
    `title`               VARCHAR(255)    NOT NULL COMMENT '比赛标题',
    `description`         TEXT            NULL     COMMENT '比赛描述',
    `problem_set_id`      BIGINT UNSIGNED NOT NULL COMMENT '关联题库ID',
    `team_id`            BIGINT UNSIGNED NOT NULL COMMENT '所属小组ID',
    `mode`                TINYINT         NOT NULL DEFAULT 0 COMMENT '赛制 0-ACM 1-OI 2-IOI 3-练习',
    `start_at`            DATETIME        NOT NULL COMMENT '开始时间',
    `end_at`              DATETIME        NOT NULL COMMENT '结束时间',
    `freeze_at`           DATETIME        NULL     COMMENT '封榜时间，NULL表示不封榜',
    `unfreeze_at`         DATETIME        NULL     COMMENT '解榜时间，NULL表示不自动解榜',
    `penalty`             INT             NOT NULL DEFAULT 20 COMMENT '罚时(分钟)，0表示无罚时',
    `access_mode`         TINYINT         NOT NULL DEFAULT 0 COMMENT '准入方式 0-组内默认 1-邀请码 2-管理员分配',
    `visibility`          TINYINT         NOT NULL DEFAULT 2 COMMENT '可见性 0-隐藏 1-组内私有 2-组内公开',
    `rank_visible`        BOOLEAN         NOT NULL DEFAULT 1 COMMENT '赛时榜单是否对参赛者可见',
    `submit_info_visible` BOOLEAN         NOT NULL DEFAULT 1 COMMENT '赛时运行内存与时间是否对参赛者可见',
    `judge_priority`      TINYINT         NOT NULL DEFAULT 2 COMMENT '判题优先级(越低越好)',
    `invite_code`         VARCHAR(64)     NULL COMMENT '邀请码',
    `announcements`       JSON            NULL COMMENT '比赛公告列表',
    `enable_clar`         BOOLEAN         NOT NULL DEFAULT 1 COMMENT '是否开启答疑服务',
    `enable_balloon`      BOOLEAN         NOT NULL DEFAULT 1 COMMENT '是否开启气球服务',
    `enable_print`     BOOLEAN         NOT NULL DEFAULT 1 COMMENT '是否开启打印服务',
    `created_by`          BIGINT UNSIGNED NOT NULL,
    `created_at`          DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_by`          BIGINT UNSIGNED NOT NULL,
    `updated_at`          DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`          DATETIME        NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_display_id` (`team_id`, `display_id`),
    INDEX `idx_team_start` (`team_id`, `start_at` DESC),
    INDEX `idx_problem_set` (`problem_set_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='比赛';
```

- **mode** 赛制枚举：

  | 值   | 含义+默认行为                                        |
  | ---- | ---------------------------------------------------- |
  | 0    | ACM：无测试点分组，按过题数-总罚时排名，判题结果可见 |
  | 1    | OI：测试点分组，按总分排名，判题结果不可见           |
  | 2    | IOI：测试点分组，按总分排名，判题结果可见            |
  | 3    | 练习：测试点分组，按过题数排名，判题结果可见         |

  > 如果需要细分，以后可以把这三个逻辑散成三个 tinyint 列

- **display_id** 分配或自定义，默认连续自增

- **unfreeze_at** 可以手动触发，立即修改该时间并解榜

- **access_mode** 

  | 值   | 含义                       |
  | ---- | -------------------------- |
  | 0    | 组内成员默认可参加         |
  | 1    | 凭邀请码加入               |
  | 2    | 由小组管理员或组长手动分配 |

- **visibility**：

  | 值   | 含义                           |
  | ---- | ------------------------------ |
  | 0    | 隐藏，仅小组管理员和组长可见   |
  | 1    | 组内私有，未被分配参加者不可见 |
  | 2    | 组内公开                       |

- **submit_info_visible** 主要是考虑到 DOM Judge 赛时不可见，但一些其他 OJ 可见，根据需求定制

- **rank_visible** 一般 OI 不可见、其他可见；但存在比赛ACM可见，考试ACM赛制且不可见榜的需求，所以单列出来

- **judge_priority** 预留，越低越好默认0。同时进行多个比赛的话，默认0(重要比赛/考试)、1(普通比赛)、2(常规：公共题库等练习、判题)、3(在线IDE)

- **announcements** 赛时短公告(一般用于纠正题目错误)，认为使用频率低且内容不大故不单独开表

> 比赛榜单实时计算和存 Redis，不会落数据库。与 Socoding OJ 一致。同理，封榜快照，做题数排行榜，赛时每道题的过题状态也走缓存。

> **idx_team_start** 用于比赛列表分页：`WHERE team_id=? ORDER BY start_at DESC`。
>
> 比赛删除用软删除，保留历史提交数据完整性
>
> 默认赛后公开题库，除非手动设置为隐藏。如果有需要再加列去做可调
>
> 在 URL 使用比赛显示 ID + 题目显示 ID。不会造成不唯一 URL

> 注意到比赛和题库不是严格一对一，如用户可以做自己的私人题库，那么它是不需要比赛的，公共题库同理

#### 参赛者表

```sql
CREATE TABLE `contest_participant` (
    `contest_id`   BIGINT UNSIGNED NOT NULL,
    `user_id`      BIGINT UNSIGNED NOT NULL,
    `joined_at`    DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
    `signed_out_at` DATETIME       NULL     COMMENT '签退时间，NULL表示未签退',
    PRIMARY KEY (`contest_id`, `user_id`),
    INDEX `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='比赛参赛者';
```

三种准入方式最终都落地到此表：`access_mode=0` 时用户点击报名(/首次提交)比赛自动写入；`access_mode=1` 凭邀请码验证后写入；`access_mode=2` 由管理员预先写入。

- **signed_out_at** 签退功能：线下比赛防止选手离场后在场外继续提交。签退后业务层拒绝该用户的提交请求。NULL 表示未签退或比赛不启用签退

> 暂时不设置参赛状态值和封禁用户表等

#### 答疑表

```sql
CREATE TABLE `contest_clarification` (
    `id`          BIGINT UNSIGNED NOT NULL,
    `contest_id`  BIGINT UNSIGNED NOT NULL COMMENT '所属比赛ID',
    `user_id`     BIGINT UNSIGNED NOT NULL COMMENT '提问者',
    `problem_id`  BIGINT UNSIGNED NULL     COMMENT '关联题目ID',
    `question`    TEXT            NOT NULL COMMENT '问题内容',
    `answer`      TEXT            NULL     COMMENT '回复内容，NULL表示未回复',
    `is_public`   BOOLEAN         NOT NULL DEFAULT 0 COMMENT '是否公开(所有参赛者可见)',
    `answered_by` BIGINT UNSIGNED NULL     COMMENT '回复者(比赛管理员)',
    `answered_at` DATETIME        NULL     COMMENT '回复时间',
    `created_at`  DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    INDEX `idx_contest_created` (`contest_id`, `created_at` DESC),
    INDEX `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='比赛答疑';
```

参赛者提问，比赛管理员回复

- **problem_id** 表示通用问题
- **is_public** 为真时所有参赛者可见该问答，类似 Codeforces 的 Clarification

> MVP 过后可考虑像讨论区一样多轮对话树状管理。

#### 气球请求表

```sql
CREATE TABLE `contest_balloon` (
    `id`          BIGINT UNSIGNED NOT NULL,
    `contest_id`  BIGINT UNSIGNED NOT NULL,
    `user_id`     BIGINT UNSIGNED NOT NULL COMMENT '过题用户',
    `problem_id`  BIGINT UNSIGNED NOT NULL COMMENT '过题题目',
    `submission_id` BIGINT UNSIGNED NOT NULL COMMENT '首次AC的提交ID',
    `status`      TINYINT         NOT NULL DEFAULT 0 COMMENT '0-待处理 1-处理中 2-已完成',
    `handler`     VARCHAR(64)     NULL     COMMENT '处理者标识(气球机客户端ID)',
    `created_at`  DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `handled_at`  DATETIME        NULL     COMMENT '处理完成时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_contest_user_problem` (`contest_id`, `user_id`, `problem_id`),
    INDEX `idx_contest_status` (`contest_id`, `status`, `created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='气球请求';
```

- 若开启，用户首次 AC 某题时自动创建记录

- 气球机客户端轮询或订阅 `status=0` 的记录，领取后更新为 `status=1`，完成后更新为 `status=2` 比赛管理员可手动调整状态（如气球送错需要重做）

- `handler` 记录哪个气球机客户端处理了该请求，便于追溯

  > 目前暂未实现，以后要实现的话需要决定 handler 的类型和 ID 格式，下同

#### 打印请求表

```sql
CREATE TABLE `contest_print` (
    `id`          BIGINT UNSIGNED NOT NULL,
    `contest_id`  BIGINT UNSIGNED NOT NULL,
    `user_id`     BIGINT UNSIGNED NOT NULL COMMENT '请求打印的用户',
    `content`     MEDIUMTEXT      NOT NULL COMMENT '打印内容',
    `status`      TINYINT         NOT NULL DEFAULT 0 COMMENT '0-待处理 1-处理中 2-已完成',
    `handler`     VARCHAR(64)     NULL     COMMENT '处理者标识(打印机客户端ID)',
    `created_at`  DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `handled_at`  DATETIME        NULL,
    PRIMARY KEY (`id`),
    INDEX `idx_contest_status` (`contest_id`, `status`, `created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='打印请求';
```

参赛者提交打印内容（纯文本或代码），打印机客户端消费

- 与气球机逻辑类似，状态机：`待处理 → 处理中 → 已完成`
- 不做唯一约束，允许同一用户多次打印

### 小组

#### 小组表

```sql
CREATE TABLE `team` (
    `id`           BIGINT UNSIGNED NOT NULL,
    `name`         VARCHAR(64)     NOT NULL COMMENT '小组名',
    `description`  TEXT            NULL     COMMENT '小组描述',
    `join_mode`    TINYINT         NOT NULL DEFAULT 0 COMMENT '加入方式 0-自由加入 1-邀请码 2-批准加入',
    `visibility`   TINYINT         NOT NULL DEFAULT 0 COMMENT '可见方式 0-仅成员可见 1-所有人可见',
    `invite_code`  VARCHAR(32)     NULL     COMMENT '邀请码',
    `is_built_in`  BOOLEAN         NOT NULL DEFAULT 0 COMMENT '是否内置(不可删除)',
    `created_by`   BIGINT UNSIGNED NOT NULL COMMENT '创建者(组长)',
    `created_at`   DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_by`   BIGINT UNSIGNED NOT NULL,
    `updated_at`   DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`   DATETIME        NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='小组';

ALTER TABLE `team`
  ADD COLUMN `name_active` VARCHAR(64)
    GENERATED ALWAYS AS (CASE WHEN `deleted_at` IS NULL THEN `name` END) STORED,
  ADD UNIQUE KEY `uk_name_active` (`name_active`);
```

- **join_mode** 三种加入方式：

  | 值   | 含义                             |
  | ---- | -------------------------------- |
  | 0    | 自由加入，任何人可直接加入       |
  | 1    | 邀请码加入                       |
  | 2    | 批准加入，由组长或小组管理员审批 |

  > `visibility=0`时不可设置 `join_mode=0`，由业务层校验

- **visibility**：仅成员可见/所有人可见

- **invite_code** 仅 `join_mode=1` 时有效

- **is_built_in** 公共小组预置，`is_built_in=1` 不可删除，不可修改 `join_mode` 和 `visibility`

- **created_by** 即组长，组长退出视为删除小组（软删除）

> `uk_name` 小组名全局唯一，方便检索
>
> 不设 `deleted_by`，组长退出即删除，`deleted_at` 由业务层写入。
>
> 可设计：公共小组 ID 预置为固定值（如 1），业务层硬编码引用。
>
> 换了表名，原和关键字 group 冲突

#### 小组成员表

```sql
CREATE TABLE `team_member` (
    `team_id`   BIGINT UNSIGNED NOT NULL,
    `user_id`    BIGINT UNSIGNED NOT NULL,
    `role`       TINYINT         NOT NULL DEFAULT 2 COMMENT '角色 0-组长 1-小组管理员 2-普通成员 3-待批准',
    `joined_at`  DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `deleted_by` BIGINT UNSIGNED NULL,
    `deleted_at` DATETIME        NULL,
    PRIMARY KEY (`team_id`, `user_id`),
    INDEX `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='小组成员';
```

- **role** 四种角色：

  | 值   | 含义                                           |
  | ---- | ---------------------------------------------- |
  | 0    | 组长，全部权限                                 |
  | 1    | 小组管理员，除管理员任免外的全部权限           |
  | 2    | 普通成员                                       |
  | 3    | 待批准加入者，`join_mode=2` 时申请后写入此状态 |

  > 全局 ADMIN/ROOT 用户在业务层等同于组长权限，不写入此表

  `role=3` 的记录表示待审批申请，审批通过后更新为 `role=2`，拒绝则直接删除该行

- **deleted_at** 软删除，自己退出或被踢出(by判断)

> 用户退出小组（软删除）后重新加入，由于主键 `(group_id, user_id)` 已存在（被软删的行），INSERT 会冲突，业务层：
>
> ```sql
> INSERT ... ON DUPLICATE KEY UPDATE deleted_at = NULL, role = 2, joined_at = NOW()
> ```

> **idx_user** 用于查询某用户加入的所有小组
>
> 每个小组有且仅有一个 `role=0` 的组长，由业务层保证。组长退出（删除小组）时，级联物理删除该小组所有成员记录
>
> 不设 `updated_at`，角色变更直接 UPDATE `role` 字段，变更时间不需要审计。

### 系统

#### 全局配置表

```sql
CREATE TABLE `system_config` (
    `config_key`   VARCHAR(64)     NOT NULL COMMENT '配置项键名',
    `config_value` VARCHAR(1024)   NULL     COMMENT '配置项值',
    `description`  VARCHAR(255)    NULL     COMMENT '配置说明',
    `updated_by`   BIGINT UNSIGNED NULL     COMMENT '最后修改者，NULL表示系统初始化',
    `updated_at`   DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='全局配置';
```

KV 结构，灵活支持任意配置项扩展，无需改表结构。

> 多级配置的命名，可如 `xxx.xxx`。

> 原则上不会增删配置项(除非版本更新)，所以不做软删除。业务层启动时将常用配置加载进 Redis，修改时同步失效缓存。不设 `created_at`，配置项由系统初始化脚本预置，后续只有 `updated_at`
>
> 不使用 JSON 单行存全部配置的理由：KV 表支持按键查询单项、按键更新单项，且每次修改有 `updated_by` 审计；单行 JSON 无法做到行级审计。

配置项：

| config_key                 | config_value | description              |
| -------------------------- | ------------ | ------------------------ |
| `oj_name`                  | `LunarOJ`    | OJ名称                   |
| `institution_name`         | `lr580`      | OJ所属主体名称           |
| `banner`                   | NULL         | OJ横幅通知               |
| `register_enabled`         | `true`       | 是否开放注册             |
| `register_email_verify`    | `false`      | 注册是否验证邮箱         |
| `submit_interval`          | `1`          | 提交间隔(秒)             |
| `nickname_review_enabled`  | `false`      | 昵称agent审查开关        |
| `ranking_refresh_interval` | `86400`      | 排行榜刷新间隔(秒)       |
| `singleton_contest_id`     | NULL         | 比赛模式下设置单场比赛ID |
| `discussion_enabled`       | `true`       | 是否开启讨论             |
| ……                         | ……           | ……                       |

> 比赛模式若所指比赛未开始/已结束，不会开启

#### 全局公告表

```sql
CREATE TABLE `announcement` (
    `id`         BIGINT UNSIGNED NOT NULL,
    `title`      VARCHAR(255)    NOT NULL COMMENT '公告标题',
    `content`    MEDIUMTEXT      NOT NULL COMMENT '公告内容Markdown',
    `is_visible` BOOLEAN         NOT NULL DEFAULT 1 COMMENT '是否可见',
    `created_by` BIGINT UNSIGNED NOT NULL,
    `created_at` DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_by` BIGINT UNSIGNED NOT NULL,
    `updated_at` DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at` DATETIME        NULL COMMENT '软删除',
    PRIMARY KEY (`id`),
    INDEX `idx_visible_created` (`is_visible`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='全局公告';
```

- **is_visible** 控制前台是否展示，管理员可随时切换

> 公告应该挺少的，不加也行

> ### 其他
>
> 以后可以加日志审计表，现在 MVP 先不考虑。
>
> ==TODO 评测机相关表，用到再设计==
>
> 统计过题列表、未过题列表可以考虑物化，也可以纯缓存。

> ## ER关系图 
>
> 以后再做。

## 整体设计思想

### ID设计

1. 雪花算法 `1符号位+41时间戳+10机器ID+12毫秒内计数序列 = 64bit`

   - 方便数据迁移，且对分库分表友好
   - 反爬虫，ID 不连续不可预测
   - 包含时间戳，本身自增，不会导致 MySQL 频繁页分裂
   - *JS Number 精度53位，丢失精度 Long 64位 ID，所以序列化时要转成字符串传给前端*
   - *MP 自带防御时钟回拨*
   - *调整时间戳起始时间，避免 2039 年溢出：这里设为 2020 年，因为使用了 Socoding OJ 的真实数据测试，这些数据最早自 2020 年*

   **主键：提交记录表、题目表、用户表等，数据库全部表使用该策略**

2. 默认连续自增 ID / 可手动分配近似连续自增

   - 用户友好，适用于需要手动输入 ID 的情况(题目、比赛等)，也可以双 id (`display_id` 连续自增)

     > 另一种情况用户在意 ID (大小对用户有情绪价值)，如洛谷 UID (或QQ号位数) 

   - URL 使用 ID 时，短更方便

   - 对分库分表、数据迁移情况，需要对 ID 重新编号

   - 32位或更短节省空间，但一般没必要

   **额外维护非主键显示ID列，对用户要输入的提供这种ID：题目、比赛皆是该逻辑**

对用户而言，①题目ID在题库按序(如 `A`, `1003`(公共题库))；②以用户名URL索引

> 不使用 UUID v4 无序字符串：页分裂；且 128 位整数过长。不推荐人工维护。

### 数据类型/字符串长度

对 VARCHAR

1. 索引字段不超过 191
   - utf8mb4 下就是 764 字节，而 InnoDB 早期索引最大索引前缀长度是 767 (新版3072 `innodb_large_prefix` 开启)
2. 非索引字段按需分配
   - 对存储空间不会浪费，但查询创建临时表时会按定义长度分配内存
   - 保留未来功能扩展空间例如路径字段，考虑层级变深

具体而言：

- 密码：128。虽然 Bcrypt 是60字符，但考虑可能会更换加密算法

- 邮箱：191 足以覆盖绝大部分邮箱，虽然未达 RFC 长度限制

- 常规：64。如账号名、昵称、学号、哈希值(SHA-256)。

- 路径：255。如路径(也可512)、标题、来源、

  > 路径的数据本身不存储数据库：测试用例(无需SQL查询与索引)、附件、图片、头像(若有)、查重报告。用 MinIO 存。附件目前暂无设计，MVP 后再说

- > 常量：32。邀请码(用户不会输入太长的)。

TEXT 64K，适用于：题面、题解

MEDIUMTEXT 16MB 代码 (变 MEDIUM 只是元数据+1字节，影响不大)

> 注意代码存数据库，理由是显著更快：
>
> - 通常很短，100w 提交每份代码 1KB 也才 1GB，MySQL 完全胜任
> - 事务一致性支持、迁移便利

JSON 原生类型：权限项、以及只存信息不频繁走查询的一对多关系(如题目-样例，代码-各测试点结果)

整型和DECIMAL按值域按需取即可

枚举类型一般使用 TINYINT 而不是 ENUM(扩展难)，在业务侧做好处理。字符串 varchar 也能用 (效率低、可能脏拼写，但可读高)。但业务侧用枚举类。

日期时间：

- 审计字段默认 DATETIME，不需要精确到 DATETIME(3)
- 同一时区，为了方便迁移可能 UTC 更好，前端负责转换显示

### 索引

不使用物理外键(不设 foreign key)，使用逻辑外键，为互联网主流做法(Socoding OJ 也是)。理由：

- 修改时触发检查，对高并发形成性能瓶颈
- 涉及分库分表时，跨库外键约束不生效；且对数据迁移不方便
- 开发时不必按依赖顺序，更加灵活
- 应用层业务做一致性检验的逻辑外键

> 对比：DomJudge 使用了物理外键

### 审计

通用审计字段：

1. created_at（datetime）记录创建时间；排查数据来源、统计、合规必备。
2. created_by（varchar）记录创建人；责任追踪、权限审计。
3. updated_at 记录最后一次修改时间；判断数据新旧、缓存失效、同步增量。
4. updated_by 记录最后修改人；定位谁改坏了数据。

软删除：is_deleted / deleted_at / deleted_by

- 很多业务不允许物理删；要可恢复、可追责、可还原历史
- 可以在业务侧设计让root可做物理删除，如对通知表等

其他：乐观锁 version 字段。

### 其他

> ### 分表策略

垂直分表：宽表、大字段、不可以索引覆盖等，为了提速

- 冷热字段分开存。

> ### 命名规范
>

表名建议单数全小写+下划线即表名 `snake_case`，字段名 `snake_case`，索引前缀 `idx_`/`uk_`/`fk_`。

> camel case 是大写取代下划线，pascal case 是首字母也大写，kebab case 是 `-` 取代 `_`。