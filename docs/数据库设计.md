[toc]

## 数据表设计

数据表：

```sql
CREATE DATABASE lunaroj
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_0900_ai_ci;
```

### 用户

#### 用户表

```sql
CREATE TABLE `user` (
    `id`                   BIGINT UNSIGNED NOT NULL,
    `username`             VARCHAR(64)     NOT NULL COMMENT '登录用户名(唯一)',
    `password`             VARCHAR(128)    NOT NULL COMMENT '密码(BCrypt加盐)',
    `nickname`             VARCHAR(64)     NOT NULL COMMENT '昵称',
    `email`                VARCHAR(191)    NULL     COMMENT '邮箱',
    `email_verified`       BOOLEAN         NOT NULL DEFAULT 0 COMMENT '邮箱是否已验证',
    `permission_group_id`  BIGINT UNSIGNED NOT NULL COMMENT '权限组ID',
    `profile`              TEXT            NULL     COMMENT '个人主页Markdown',
    `default_code_public`  BOOLEAN         NOT NULL DEFAULT 0 COMMENT '提交代码默认是否公开',
    `last_login_at`        DATETIME        NULL     COMMENT '最后登录时间',
    `created_at`           DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    `updated_at`           DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`           DATETIME        NULL COMMENT '软删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_username` (`username`),
    UNIQUE KEY `uk_email` (`email`),
    INDEX `idx_permission_group` (`permission_group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户';
```

- **id** 雪花ID，如无特殊说明，后面都是

- **username** 登录用户名只能大小写英文+阿拉伯数字+`-_.`

  大小写不敏感(登录时和注册防重时)：与主流平台 cf、力扣、atc、Github 一致，以及 Socoding OJ 一致

  但存储时保留大小写，不要一律转小写，与 Socoding OJ 保持一致

- **deleted_at** 用于删除用户，但不删除用户对应的提交代码等数据

- **email** 可以为空(不验证邮箱)，root 可以调，所以设可 NULL

防重列需求使用 EAV 实现，可以支持任意多个自定义防重列，单开一个表，2个属性(列名、列值)存储用户的特定属性，由业务层判断。因此，不采纳如下：

> ```sql
> `anti_duplicate_value` VARCHAR(128) NULL COMMENT '防重列值(学号/手机等)',
> ```

限频字段存 Redis 可以，不需要放 MySQL：

- `last_nickname_change` '上次修改昵称时间(限频)',
- `last_profile_change` '上次修改个人主页时间(限频)',

同理，JWT 字段存 Redis，不走 MySQL。

> 不打算做，未来可做：
>
> ```sql
> `avatar_url` VARCHAR(512) NULL COMMENT '头像URL(MinIO)',
> ```

如果经常前缀搜索用户昵称，也可以加个索引列。

#### 权限组表

```sql
CREATE TABLE `permission_group` (
    `id`          BIGINT       UNSIGNED NOT NULL,
    `name`        VARCHAR(64)  NOT NULL COMMENT '权限组名称',
    `permissions` JSON         NULL     COMMENT '权限列表 ',
    `description` VARCHAR(255) NULL     COMMENT '描述',
    `is_built_in` BOOLEAN      NOT NULL DEFAULT 0 COMMENT '是否内置(内置不可删除)',
    `created_at`  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限组';
```

- **name** 权限组默认有 `USER / ADMIN / ROOT` 三个

  varchar 64 是为了可扩展 (root 可以自定义新的组，其name可能长)

  > 一般建议不是中文，暂不考虑做限制
  >
  > 不拿 name 当 PK，理由是若更新，级联更新 FK 不方便且比 bigint 大

- **permissions** JSON 便于动态扩展，为简单起见，使用扁平设计，如：

  `["problem.read","contest.rejudge"]`

  > 分模块的话是 `{"problem":["read","edit"]}`，暂不考虑。
  >
  > 用 JSON 好处是类型约束，保证合法

- **description** 对该组的描述，备注，可中文

> 暂不考虑添加：**deleted_at** 软删除，等效于做隐藏。未来可以实现。
>
> 因为只有 root 可以更改这个表，所以不考虑设置 created_by, updated_by。

> id 雪花和自增都行。这里默认雪花。

#### 通知表

```sql
CREATE TABLE `notification` (
    `id`          BIGINT UNSIGNED NOT NULL,
    `user_id`     BIGINT UNSIGNED NOT NULL COMMENT '接收用户',
    `type`        TINYINT       NOT NULL COMMENT '消息类型',
    `title`       VARCHAR(255)  NOT NULL,
    `content`     TEXT          NULL,
    `read_at`     DATETIME      NULL,
    `created_at`  DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `deleted_at`  DATETIME      NULL COMMENT '软删除',
    PRIMARY KEY (`id`),
    INDEX `idx_user_read_created` (`user_id`, `read_at`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知消息';
```

做索引优化，以方便 select。业务侧定义具体每种 type 的名字等。

#### 用户属性表

```sql
CREATE TABLE `user_attribute` (
    `user_id`    BIGINT UNSIGNED NOT NULL,
    `attr_key`   VARCHAR(64)     NOT NULL COMMENT '属性名',
    `attr_value` VARCHAR(191)    NOT NULL COMMENT '属性值',
    PRIMARY KEY (`user_id`, `attr_key`),
    UNIQUE KEY `uk_key_value` (`attr_key`, `attr_value`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户扩展属性';
```

EAV 防重表。未来用于存储：学号、手机、联系方式等字段，并选择任意一到多个进行注册防重。

### 题目

#### 标签分类表

```sql
CREATE TABLE `tag_category` (
    `id`         BIGINT UNSIGNED NOT NULL,
    `name`       VARCHAR(16)  NOT NULL COMMENT '分类名',
    `sort_order` INT          NOT NULL DEFAULT 0,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签分类';
```

用于多个维度进行筛选题目，每个维度是一个类别，如考点、出处。参考洛谷。

- **sort_order** 是在排列各种筛选类型的顺序，越小越前。下同。

  > 避免使用 order 这个关键字 (order by)

> ID 雪花和自增都行。这里默认雪花。下同。
>
> 认为这种非重要的列，没有必要做审计，故不设计 created_at 等。下同。

#### 标签表

```sql
CREATE TABLE `tag` (
    `id`          BIGINT UNSIGNED NOT NULL,
    `name`        VARCHAR(64)  NOT NULL COMMENT '标签名',
    `category_id` BIGINT  UNSIGNED NOT NULL COMMENT '所属分类',
    `sort_order`       INT     NOT NULL DEFAULT 0,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_name` (`name`),
    INDEX `idx_category` (`category_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签';
```

- **name** 通常认为不同类别不会有同名标签，直接 unique。 

> 不考虑为分类和标签添加颜色字段，认为没必要。前端随便选即可。
>
> 不应该把标签看成弱实体，仍然需要 ID。

#### 题目表

> TODO 是否要垂直分表？

```sql
CREATE TABLE `problem` (
    `id`                BIGINT UNSIGNED NOT NULL,
    `title`             VARCHAR(255)  NOT NULL COMMENT '题目标题',
    `description`       MEDIUMTEXT    NOT NULL COMMENT '题面Markdown/HTML',
    `input_description` TEXT          NULL     COMMENT '输入描述',
    `output_description` TEXT         NULL     COMMENT '输出描述',
    `samples`           JSON          NULL     COMMENT '样例列表',
    `note`              TEXT          NULL     COMMENT '提示',
    `time_limit`        INT           NOT NULL DEFAULT 1000 COMMENT '时间限制(ms)',
    `memory_limit`      INT           NOT NULL DEFAULT 262144 COMMENT '内存限制(KB), 默认256MB',
    `difficulty`        INT           NULL     COMMENT '难度, NULL为未设置',
    `difficulty_manual` BOOLEAN       NOT NULL DEFAULT 0 COMMENT '难度来源: MANUAL / AI',
    `solution`          MEDIUMTEXT    NULL     COMMENT '题解Markdown',
    `solution_visible`  BOOLEAN       NOT NULL DEFAULT 0 COMMENT '题解是否可见',
    `std_code`          TEXT          NULL     COMMENT '标程代码',
    `std_language`      TINYINT       NULL     COMMENT '标程语言 0-C++, 1-C, 2-Python, 3-Java, 4-txt',
    `std_visible`       BOOLEAN       NOT NULL DEFAULT 0 COMMENT '标程是否可见',
    `judge_mode`        TINYINT       NOT NULL DEFAULT 0 COMMENT '0-常规 1-SPJ 2-填空题 3-交互题',
    `scoring_config`    JSON          NULL COMMENT '测试点分值配置',
    `spj_code`          TEXT          NULL     COMMENT 'SPJ代码',
    `spj_language`      TINYINT       NULL     COMMENT 'SPJ语言',
    `total_score`       INT           NOT NULL DEFAULT 0 COMMENT '总分, 0表示不设置',
    `accept_count`      INT           NOT NULL DEFAULT 0 COMMENT 'AC数',
    `submit_count`      INT           NOT NULL DEFAULT 0 COMMENT '提交数',
    
    `status`            TINYINT NOT NULL DEFAULT 0 COMMENT '0-草稿 1-待审核 2-已发布 3-已下架',
    `reviewed_by`       BIGINT UNSIGNED NULL COMMENT '审核题目者的用户ID',
    `reviewed_at`       DATETIME      NULL,
    `created_by`        BIGINT UNSIGNED NOT NULL COMMENT '创建者用户ID',
    `created_at`        DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_by`        BIGINT UNSIGNED NOT NULL,
    `updated_at`        DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_by`        BIGINT UNSIGNED NULL,
    `deleted_at`        DATETIME      NULL,
    PRIMARY KEY (`id`),
    INDEX `idx_creator` (`created_by`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题目';
```

- **samples** 是所有样例输入和输出 JSON 格式 `[{"input":"...","output":"..."},...]`
- **notes** 一般是：部分分说明，样例解释，更新说明
- **difficulty** 对标CF rating，也可以按需自定义，如对标[力扣](https://zerotrac.github.io/leetcode_problem_rating/)
- **scoring_config** 对标 OI/IOI 子任务配置，参考 [Socoding OJ 格式](https://github.com/scnu-socoding/scnuoj/blob/master/views/wiki/oi.php)
- **std_language** 使用整型而不是 varchar，因为不同地方可能用的字符值不一样(如沙箱cpp，前端C++)，以及牵扯到编译器版本
- **judge_mode** 保留以后添加其他选项的可能性
- **spj_language** DOMjudge 的 output validator 可以用任意语言，只需编译/运行后通过退出码返回结果
- **status** 草稿：已保存但还不想提交审核；已下架：因为一些原因需要把已发布的题目退掉时可用

> 注意题目(题面、输入输出格式描述等)本身应当存数据库，编辑检索方便，如 Socoding OJ (SCNUOJ), Online Judge (QDU OJ)，Hydro OJ，HUST OJ。例外是 DOM Judge，它的题目是 PDF 文件。

> 对样例输入输出，Socoding OJ 的做法是存两个 TEXT，处理字符串解析得到样例。不考虑分表，太麻烦，故可以做 JSON 存字符串。
>
> 但是，若希望样例也测。而 DOM Judge 和 online judge (qduoj/csoj) 的模式是样例本身是测试点，按测试点存储即可。考虑这个功能，可以前端添加一键把样例转为测试点，或反之。一个坏处是走文件读写比纯查分表/单表JSON慢。
>
> 这里设计样例与测试点无关，因为考虑到一些出题人给分策略(OI/IOI)可能不希望让样例算分。而且也比文件IO快。

> 一些看似是题目内容但不存储在这里的是：显示id (随题库变化)、测试点给分方式 (题目配置文件确定)
>
> 标题、题面内容不走 MySQL 索引，对检索需求用其他手段实现；其他内容也可以走 Redis。

> 不设计每个样例单独解释，在题目里统一解释。与 Socoding OJ、洛谷等保持一致。

> 暂时不考虑设计由代码生成的样例、热点生成缓存相关的数据库结构。MVP 之后有空可以实现。

#### 题目标签表

```sql
CREATE TABLE `problem_tag` (
    `problem_id` BIGINT UNSIGNED NOT NULL,
    `tag_id`     BIGINT UNSIGNED NOT NULL,
    PRIMARY KEY (`problem_id`, `tag_id`),
    INDEX `idx_tag_id` (`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题目-标签关联';
```

虽然题目与样例、标签都是一对多关系。但是标签经常用来查询，单独分表更加合适。

标签分类表、标签表是实体，需要 ID，但是题目标签是关联，不需要分配额外 ID。

#### 测试点表

```sql
CREATE TABLE `test_case` (
    `problem_id`      BIGINT UNSIGNED NOT NULL,
    `sort_order`      INT             NOT NULL DEFAULT 0,
    `input_path`      VARCHAR(255)    NULL     COMMENT '输入文件MinIO路径',
    `output_path`     VARCHAR(255)    NULL     COMMENT '输出文件MinIO路径, NULL表示待生成',
    `input_size`      BIGINT          NULL     COMMENT 'bytes',
    `output_size`     BIGINT          NULL     COMMENT 'bytes',
    `input_hash`      VARCHAR(64)     NULL     COMMENT '输入文件SHA-256',
    `output_hash`     VARCHAR(64)     NULL     COMMENT '输出文件SHA-256',
    `created_by`      BIGINT UNSIGNED NOT NULL COMMENT '创建者用户ID',
    `updated_by`      BIGINT UNSIGNED NOT NULL COMMENT '最后修改者用户ID',
    `created_at`      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`problem_id`, `sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='测试点';
```

- path：测试点/附件本身必须存文件。
- 大小字段：①快速统计限额；②方便CRUD管理展示，不必每次都调 MinIO
- 哈希字段：SHA-256 hex是64字符。作用有三①上传时去重；②重判时校验是否被修改；③可以快速检查标程重新生成的输出是否不一样

> 其他实现：Socoding OJ 数据库不存测试点，通过扫描文件路径发现。HUSTOJ 用配置文件描述测试点信息。DOMJudge 有数据表存测试点元数据。
>
> 弱实体不需要 ID 字段。如果加一个 ID 字段方便改顺序/分组，但一般认为调整顺序的需求少。也不考虑加名字/描述等字段。
>
> 填空题可以无输入(NULL)。
>
> 未实现代码生成的测试点的管理。MVP 后可考虑。



> 提交代码垂直分表，支持高速查询

## ER关系图

## 整体设计思想

### ID设计

1. 雪花算法 `1符号位+41时间戳+10机器ID+12毫秒内计数序列 = 64bit`

   - 方便数据迁移，且对分库分表友好
   - 反爬虫，ID 不连续不可预测
   - 包含时间戳，本身自增，不会导致 MySQL 频繁页分裂
   - *JS Number 精度53位，丢失精度 Long 64位 ID，所以序列化时要转成字符串传给前端*
   - *MP 自带防御时钟回拨*
   - *调整时间戳起始时间，避免 2039 年溢出：这里设为 2020 年，因为使用了 Socoding OJ 的真实数据测试，这些数据最早自 2020 年*

   **主键：提交记录表、题目表、用户表等，数据库全部表使用该策略**

2. 默认连续自增 ID / 可手动分配近似连续自增

   - 用户友好，适用于需要手动输入 ID 的情况(题目、比赛等)，也可以双 id (`display_id` 连续自增)

     > 另一种情况用户在意 ID (大小对用户有情绪价值)，如洛谷 UID (或QQ号位数) 

   - URL 使用 ID 时，短更方便

   - 对分库分表、数据迁移情况，需要对 ID 重新编号

   - 32位或更短节省空间，但一般没必要

   **额外维护非主键显示ID列，对用户要输入的提供这种ID：题目、比赛皆是该逻辑**

对用户而言，①题目ID在题库按序(如 `A`, `1003`(公共题库))；②以用户名URL索引

> 不使用 UUID v4 无序字符串：页分裂；且 128 位整数过长。不推荐人工维护。

### 数据类型/字符串长度

对 VARCHAR

1. 索引字段不超过 191
   - utf8mb4 下就是 764 字节，而 InnoDB 早期索引最大索引前缀长度是 767 (新版3072 `innodb_large_prefix` 开启)
2. 非索引字段按需分配
   - 对存储空间不会浪费，但查询创建临时表时会按定义长度分配内存
   - 保留未来功能扩展空间例如路径字段，考虑层级变深

具体而言：

- 密码：128。虽然 Bcrypt 是60字符，但考虑可能会更换加密算法

- 邮箱：191 足以覆盖绝大部分邮箱，虽然未达 RFC 长度限制

- 常规：64。如账号名、昵称、学号、哈希值(SHA-256)。

- 路径：255。如路径(也可512)、标题、来源、

  > 路径的数据本身不存储数据库：测试用例(无需SQL查询与索引)、附件、图片、头像(若有)、查重报告。用 MinIO 存。

- > 常量：32。邀请码(用户不会输入太长的)。

TEXT 64K，适用于：题面、题解

MEDIUMTEXT 16MB 代码 (变 MEDIUM 只是元数据+1字节，影响不大)

> 注意代码存数据库，理由是显著更快：
>
> - 通常很短，100w 提交每份代码 1KB 也才 1GB，MySQL 完全胜任
> - 事务一致性支持、迁移便利

JSON 原生类型：配置项、权限项

整型和DECIMAL按值域按需取即可

枚举类型一般使用 TINYINT 而不是 ENUM(扩展难)，在业务侧做好处理。字符串 varchar 也能用 (效率低、可能脏拼写，但可读高)。但业务侧用枚举类。

日期时间：

- 审计字段默认 DATETIME，不需要精确到 DATETIME(3)

### 索引

不使用物理外键(不设 foreign key)，使用逻辑外键，为互联网主流做法(Socoding OJ 也是)。理由：

- 修改时触发检查，对高并发形成性能瓶颈
- 涉及分库分表时，跨库外键约束不生效；且对数据迁移不方便
- 开发时不必按依赖顺序，更加灵活
- 应用层业务做一致性检验的逻辑外键

> 对比：DomJudge 使用了物理外键

### 审计

通用审计字段：

1. created_at（datetime）记录创建时间；排查数据来源、统计、合规必备。
2. created_by（varchar）记录创建人；责任追踪、权限审计。
3. updated_at 记录最后一次修改时间；判断数据新旧、缓存失效、同步增量。
4. updated_by 记录最后修改人；定位谁改坏了数据。

软删除：is_deleted / deleted_at / deleted_by

- 很多业务不允许物理删；要可恢复、可追责、可还原历史

其他：乐观锁 version 字段。

### 其他

> ### 分表策略

垂直分表：宽表、大字段、不可以索引覆盖等，为了提速

- 冷热字段分开存。

> ### 命名规范
>

表名建议单数全小写+下划线即表名 `snake_case`，字段名 `snake_case`，索引前缀 `idx_`/`uk_`/`fk_`。

> camel case 是大写取代下划线，pascal case 是首字母也大写，kebab case 是 `-` 取代 `_`。