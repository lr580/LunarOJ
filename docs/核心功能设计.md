> 这种格式描述的是可选需求，在 MVP 下不优先实现。其他是必须需求。

*斜体格式是补充注释，不是功能本身*

综合优先级顺序：

1. 用户、题目、评测机、代码提交、题库
2. 比赛、agent、出题
3. 小组、SPJ、分布式评测机、其他功能

## 评测机系统

1. 支持单机

   > 应可扩展到分布式多评测机

2. 公平：尽可能避免抖动，时空开销稳定

3. 实现沙箱权限隔离，限制时空开销并防止用户提交恶意代码

4. 支持多个语言，包括但不限于 C++20，C，Java21，Python3.13，纯文本(填空题)，golang，并方便扩展

5. 支持普通评测(处理空白字符)

   > 支持SPJ、交互题

*可考虑用MQ负责评测机消费代码或其他办法；用 Linux cgroup 等办法做沙箱，实现内存等限制，可参考 criyle Go-Judge 或 onlinejudge(seccomp)；一种公平思路：多次测/固定cpu频率*

## 题目

1. 支持 Markdown，

   > 包含图片和动图、附件下载 (均服务器本地存储)；也可以用 PDF / 图片给定题目

2. 包含整数ID、题面、时空限制、输入输出描述和任意多个样例(可复制/下载)、任意多个标签、难度(对标CF，可让agent评分(标记AI打分)或手动设置)、标程、题解、创建者

   > 可选：出处(字符串)；或者由标签实现；标程由root设置是否随题解公开；题解可以勾选隐藏
   >
   > agent：辅助优化、规范格式化出题、验题、造数据或提供出题帮助

3. > 支持设置分值(正整数，0/-1为不设置)、支持：①全对才给分(此时判题优化，有错马上停判)、②按测试点平均给分、③测试点分组，每组全对给该组的分

4. 提供题目检索功能，多维查询，灵活分页，以及输入文本让智能匹配最相近的若干题目

5. > 提供Markdown或在线pdf渲染题解、讨论区

6. > 支持批量导入导出题目，与本OJ、CF、DomJudge 格式互通

*题目匹配：向量数据库+embedding*

## 用户

1. 按权限组划分权限，分为：普通用户、管理员、root (逐级递增)，支持方便扩展和修改 (如具体权限存配置)

   > root 可动态设置权限组配置，并增删权限组

2. 基本信息为密码(加盐加密)、昵称、邮箱(用于验证注册，找回密码)、注册时间、(学号)防重列

   > 其中，①root可以决定是否开放注册；是否注册不验证邮箱
   >
   > ②防重列由root决定列名，是字符串，一般是手机/学号。
   >

   > ③昵称agent审查，不允许敏感和不雅名称，由root决定是否开启，root可自定义规则，对敏感结果上报管理员和root；异步处理避免阻塞，默认成功，避免阻塞；若agent不可用降级默认放行
   >
   > 为防止agent耗尽，每人每天只允许修改一次昵称和个人主页

3. > 支持 Markdown 个人主页；同样可开启审查

4. 统计过题列表、未过题列表 (均支持搜索)、过题率

   > 考虑用户 rating/统计值变化曲线

5. 用户登录需要输入图形验证码；root可以设置用户登录过期时间或永不过期

6. > 通知消息列表，负责比赛提醒、审核反馈等，无需刷新即可收到消息

7. 允许修改密码，修改邮箱

   > 忘记邮箱等情况允许发送找回账号请求，管理员和root后端可不刷新即收到(确保赛时响应及时)

8. > 考虑用户头像，但审核是个问题

*鉴权：可参考 Spring Security + JWT；RBAC模型；无需刷新是WebSocket/SSE*

## 小组

> MVP 阶段只保留公共小组，其他内容暂不实现

1. 功能为个人组队、班级等，并与题库、比赛关联

2. 一个用户属于一到多个小组 (默认属于公共小组)

3. 设有组名、小组描述、创立时间、创建人

4. 小组权限为 ①组长(创建人) 全部权限；②小组管理员(除管理员任免外的全部权限)；③普通成员；④待批准加入者

   *特别地，默认管理员和root用户等同于拥有组长的全部权限，后面描述组长时，等价于组长=组长+管理员+root (管理员≠小组管理员)*

   > 可让组长配置小组管理员、普通成员的权限列表，如是否可创建比赛

5. 加入方式：①自由加入；②使用邀请码加入；③批准加入 (由组长或小组管理员)

6. 除公共小组外，均可以自由退出，无需审核；组长退出视为删除

7. 可见方式：①所有人可见；②仅成员可见 (则不可以设置③的加入方式)

## 题库

1. 一个题目有序地属于多个题库，根据题库可见性决定题目是否可见。

   > 比赛题目显示顺序格式默认是 A-Z，数量>26或练习时，使用数字；可以修改显示格式

2. 设有题库名，创建者，创建时间，一到多个标签 (与题目共用标签集)

   > 标签应支持便捷查询；标签集只允许管理员和root修改，设有便捷CRUD，可让agent自动生成标签集，root可编辑提示词
   >
   > 标签可设有分类，如①考点；②出处。同样由管理员和root维护

3. 一个小组拥有一道多个题库，公共小组拥有公共题库。前端展示题库列表和支持简单检索与分页

4. 默认小组管理员和组长允许创建与管理题库，普通用户只能从公共题库里选择题目，管理员和root能选择全部题目

5. > 支持题目批量选择(多种选择依据)，支持拖拽重排序，以及更多便捷CRUD方式

6. > 题库题解是各题题解的按顺序拼接。也可以反过来：上传题解，若是 md，允许agent或md解析方式自动划分并设为各题题解

7. > 提供题册打印，导入导出题库功能

8. 默认允许查看测试点截断部分

   > 测试点查看方式：①不允许查看；②允许查看截断部分；③允许查看全部与下载
   >
   > *只有③会在AC时仍然显示；②只显示非AC的测试点*

   > 统一题库内每题的查看方式；比赛默认①。不设置每题粒度的查看方式

9. > 用户可以创建任意多个自己的题册，在这种情况下，题库不属于小组，只能被用户个人访问(在题库列表)，在小组添加题库时可选择这些题库

## 比赛

1. 比赛与题库一对一关系，一个题库可被多个比赛使用(复用以重现赛等)；

   一个比赛属于一个小组(用小组来快速决定比赛的可见性)；

   *根据比赛的可见性决定题库的可见性和可见时间，故若不分配比赛，该题库只对小组管理员和组长可见*

2. 赛制：①ACM/ICPC；②OI；③IOI；④练习

   *练习模式等同于无比赛，*

   > 允许root自定义赛制；优先实现①④

3. 比赛属性：标题、开始时间、结束时间、封榜时间(不与赛制绑定，默认acm80%，其他不来)、解绑时间(默认1h)、罚时(0为无，默认20分钟)、描述(字符串)、创建者

   封榜冻结一个静态榜单，但允许比赛管理员查看实时榜单

4. 准入方式：①组内默认可参加；②邀请码；③小组管理员或组长分配

   > 对③提供方便的 CRUD

5. 可见性：①组内公开；②组内私有(未被③分配参加不可见)；③隐藏(适用于比赛还没建好，仅小组管理员和组长可见)

6. 榜单可见性：决定赛时用户是否能看榜

7. > 赛时公告：创建者、小组管理员和组长 (*下面简称比赛管理员*)可发布，所有参赛者可按顺序查看，发布时参赛者无需刷新即可收到弹窗提示

8. > 是否开启答疑：开启时，参赛者允许向比赛管理员发送字符串消息；比赛管理员无需刷新即可收到弹窗提示

9. > 赛后滚榜。可以基于现成工具ICPC Resolver或自己设计/修改

10. > 是否开启打印机

11. > 是否开启气球机
    >
    > 打印机和气球机共用相似的资源调度逻辑，需要访问特定 URL，输入验证码(默认是比赛id)，无需登录即可登录打印机/气球机客户端，负责消费打印/气球请求。消费状态：①待处理；②处理中；③已处理。需要防止竞态，且比赛管理员可以调整状态(需要重做的话)。若开启气球机，过题默认发送气球请求。可考虑消息队列实现。

12. > 支持对赛时提交代码进行多种方式筛选(如仅保留最后一次提交，仅保留AC代码，保留全部)与导出；支持比赛的导入导出(含提交+选手或只含题目等元信息)，支持导出为其他样式的终榜长图/静态html

13. > 支持赛后使用JPlag代码查重，也可以自定义规则，如引入agent离线任务

14. 重判：比赛管理员可以指定单个提交ID/单个题目或整个比赛进行重判。

    > root可以设置这个权限开放的级别：普通用户(小组管理员，组长)，管理员，仅root

15. 支持防作弊系统，最低目标为开启全局单例比赛，即在赛时降级ban掉所有非重要功能(公共题库、其他比赛、个人主页、讨论区等)，防止用户在这些功能里打小抄

    > 签退功能：线下比赛防止选手离场后在场外用电脑再次登入继续比赛，要求在离开考场前确认或设置已签退，签退后不能再交题
    >
    
    > 理想目标为：相互隔离，可以进行多个比赛，各自防作弊。但需要处理：赛时用户登出，然后用小号访问这些资源。考虑到机房时常因电脑故障换电脑，难以根据客户端IP等做限制。以及需要对多种情况处理；
    >
    > 也可以考虑引入IP分段限制
    >
    > 可能需要设置判题优先级，重要比赛1，普通比赛2，普通题库3，IDE调试4。有更高级别队列等待判题时，低级别的阻塞排队。队内FIFO
    >
    > 其他防作弊：切屏检测前段监听；
    >
    > 实现复杂，建议只做全局单例比赛

*榜单：Redis ZSet；比赛刚开始防止缓存穿透*

## 代码提交

1. 提交状态：Pending、AC、WA、TLE、MLE、RE、CE、OLM、UKE(系统错误)，先遇到什么抛什么，以第一个非AC测试点状态为准

2. 提供代码IDE文本框，语言选择

   > 可以提供在线IDE，需要做好判题队列优先级

3. 在题库级别隔离显示不同的提交记录；但个人可以查询自己的全部提交记录；支持分页和多种检索

4. 显示信息：运行ID、作者、题目ID+名、测评结果、分数(`满分`或具体部分分值)、用时、内存、语言、代码长度、提交时间

5. 点进去可以查看完整代码；作者可设置公开或私密(仅自己和比赛管理员可见)，可以设置默认公开/私密；root可以设置是否能让比赛管理员直接调整比赛指定代码公开性，提供代码下载按钮；root可以直接关闭可见性(等价于全私有)

   还可以查看具体测试点通过统计与每个测试点的时间、内存

6. 设置一个按钮，选择是否只看赛时提交

7. > Copilot agent：使用模板提示词、选择模型，提供：①CR；②复杂度/正确性分析；③智能补全；④CE等时提供智能分析
   >
   > 使用 SSE 流式返回AI输出结果，不要用短连接
   >
   > root设置每个用户每日(或24h窗口)最大使用次数，每个模型可设置不同的权重

8. 限制代码最大提交长度为65535字符，限制提交频率(默认1s)

   > root可修改限制

*该数据库必须分表，考虑按时间或比赛id；判题结果 WebSocket 推送*

## 出题

1. 默认任何用户都可以出题(root可调)，只有一套出题系统，题目ID不为空证明题目可用，普通用户不可设置题目ID，只有管理员和root审核通过后可以为其分配ID

2. 普通用户只能看到自己创建的题目，管理员和root可以看到全部题目，root可以CRUD全部题目 (root可设置)

3. 可以只上传输入测试点和标程(zip/单多文件)，一键生成所有输出测试点；也可以直接上传全部测试点；支持方便的 CRUD，测试点存外部文件

   > root可以设置限制每个用户每天(/24h窗口)最大上传/下载测试点大小，避免ddos，也可以不设限；root可以设置单测试点最大长度
   >
   > 支持上传生成测试点的代码的方式来代替上传测试点
   >
   > 对由程序生成的固定测试点，允许提交生成代码，若无测试点，评测时先生成测试点再评测；root可设置若超过给定时间，自动清理这些测试点

4. 可开启 SPJ (做好权限控制)、交互题；可以提交代码验题

5. > 支持方便的导入导出，应当支持本 OJ， DomJudge, CF 等

## 后台

1. 监控：当前时间、已运行时间、CPU状态、内存状态、硬盘状态、网络情况(入网，出网，实时)
2. 全局配置项：如上所述。还包含：全局公告、OJ名字、组织名字、提交间隔时间、开启讨论区、小组创建开放级别、邮箱服务器发信服务配置、agent baseurls/apikeys和提示词配置
3. 对全局公告列表的 CRUD (每个公告是一个 Markdown 渲染的文档)，存储创建时间，可见性
4. 对用户的 CRUD，如对找回账号请求或直接修改用户密码，批量创建用户
5. 对题目、题库、比赛的 CRUD，方便的分页和多种检索
6. 通知系统随时不刷新即可接受新的信息(审题通知、找回账号通知、UKE通知等)
7. > 提供数据备份与恢复

*监控：Prometheus + Grafana*

## 杂项

1. 标题和全局公告列表

2. 排行榜：所有用户的过题数排名，支持同名次；每日刷新一次(root可调)

   > root可设置懒加载，只有超过刷新时限且有人访问才异步刷新(第一个访问者仍看到旧数据)，记得加锁

3. 帮助文档

4. > 云剪贴板功能，可用短链，可设置过期时间(root配置最大可设置范围或允许永不过期)。建议不实现

4. > 实现日志审计：管理员等操作日志、评测日志

*RESTful API；接口限流(令牌桶/滑动窗口)、SQL注入/XSS防护、CSRF防护；文件上传安全*